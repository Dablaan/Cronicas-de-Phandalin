# Arquitectura y Estructura: CrÃ³nicas de Phandalin

SPA Vanilla JS + Supabase BaaS para gestiÃ³n de campaÃ±as D&D en tiempo real.

## Ãrbol de Directorios

```text
ğŸ“¦ Cronicas-de-Phandalin
 â”£ ğŸ“‚ img/             # Avatares, tokens, fondos
 â”£ ğŸ“‚ css/
 â”ƒ â”— ğŸ“œ styles.css     # 1407 lÃ­neas. Variables, grid, card-horizontal, responsive
 â”£ ğŸ“œ index.html       # Entry-Point (204 lÃ­neas). Modales: auth, entity, quick-look, lightbox
 â”— ğŸ“‚ js/
   â”£ ğŸ“œ main.js         # Bootstrap: init Auth â†’ init State â†’ subscribe renderApp (31 lÃ­neas)
   â”£ ğŸ“œ auth.js         # Login DM (clave '1234'), selecciÃ³n de PJ, logout (55 lÃ­neas)
   â”£ ğŸ“œ storageAdapter.js # Supabase CRUD + Realtime + Storage (avatars, campaign_media) (137 lÃ­neas)
   â”£ ğŸ“œ state.js        # Store Redux-like con merge inteligente Player/DM (138 lÃ­neas)
   â”— ğŸ“œ ui.js           # Motor de renderizado DOM masivo. 95 funciones, 2448 lÃ­neas
```

## Flujo de Datos (MVC Simplificado)

1. **View** (`ui.js`): Evento del usuario (clic, input)
2. **Action** (`window.*`): FunciÃ³n global invocada desde HTML literal
3. **Reducer** (`state.update(partial)`): Merge local + fetch remoto
4. **Backend** (`storageAdapter.save()`): Upsert a Supabase `kv_store`
5. **Re-render**: WebSocket `postgres_changes` â†’ `state.notify()` â†’ `renderApp()`

## Modelo de Datos (`kv_store.value`)

```json
{
  "session": { "role": "DM|Player", "playerId": "..." },
  "players": [{ "id", "name", "hpCurrent", "hpMax", "stats", "skills", "attacks", "spells", "spellSlots", "equipment", "passcode" }],
  "npcs": [{ "id", "name", "isVisible", "url", "ac", "hp", "raceAlignment", "behavior", "motivation", "secrets", "notes" }],
  "maps": [{ "id", "name", "url", "isVisible", "environmentType", "dmNotes", "secrets", "notes" }],
  "bestiario": [{ "id", "name", "subtitle", "ac", "hp", "speed", "init", "str-cha", "saves", "skills", "senses", "langs", "challenge", "immunities", "features", "actions", "bonus", "reactions", "equip", "url" }],
  "encuentros": [{ "id", "name", "location", "loot", "monsters": [{ "id", "name", "qty" }] }],
  "recursos": [{ "id", "nombre", "portadaUrl", "enlaceUrl" }],
  "notes": { "[playerId]": "texto" }
}
```

## Sistema CSS Clave

| Clase | Uso |
|---|---|
| `.card` | Tarjeta base (pergamino, box-sizing, overflow hidden) |
| `.card-horizontal` | Flex-row con `.card-horizontal-img` + `.card-horizontal-content`. Se reduce a gap/img menores en â‰¤600px |
| `.grid-2` | 1 col mobile â†’ 2 col â‰¥768px |
| `.biblioteca-grid` | 3 col desktop â†’ 2 col â‰¤600px â†’ 4 col landscape |

## Decisiones TÃ©cnicas

- **HTML Literal** en `ui.js` (template literals) sin bundler
- **Merge Optimista**: `state.update` hace pull remoto antes de guardar; jugadores solo patchean su propio objeto
- **Session aislada**: Nunca se sube a Supabase
- **Edit Mode Guard** (`window.isSheetEditMode`): Bloquea re-renders remotos mientras el jugador edita
