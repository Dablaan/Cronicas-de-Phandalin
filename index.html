<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Crónicas de Phandalin</title>
    <!-- PWA & Mobile Web App settings -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Crónicas">
    <link rel="apple-touch-icon" href="./img/icono-app.png?v=2">
    <link rel="icon" type="image/png" href="./img/icono-app.png?v=2">

    <!-- Fonts: Cinzel for headers, Lora for body -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Lora:ital,wght@0,400;0,700;1,400&display=swap"
        rel="stylesheet">
    <!-- FontAwesome CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Supabase CDN (Realtime Database) -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- Styles -->
    <link rel="stylesheet" href="./css/styles.css">
</head>

<body>
    <div id="app" class="app-container">
        <!-- Screens will be injected here by ui.js -->
        <div id="loading-screen" class="screen active">
            <div class="loader-content">
                <i class="fa-solid fa-dice-d20 fa-spin fa-3x"></i>
                <h2>Cargando Crónicas...</h2>
            </div>
        </div>

        <!-- Auth Screen (Landing & Selection) -->
        <div id="auth-screen" class="screen">

            <!-- Landing View -->
            <div id="landing-screen" class="landing-container">
                <div class="header" style="border-bottom: none; padding-bottom: 0;">
                    <h1 style="font-size: 4rem; text-shadow: 2px 2px 4px rgba(0,0,0,0.5);">CRÓNICAS DE PHANDALIN</h1>
                    <p style="font-size: 1.5rem; margin-bottom: 1rem;">Elige tu destino...</p>
                </div>
                <div class="landing-image-wrapper mb-1">
                    <img src="./img/party.png" alt="Grupo de Aventureros" class="landing-image"
                        onerror="this.src='data:image/svg+xml;utf8,<svg xmlns=\\\'http://www.w3.org/2000/svg\\\' width=\\\'800\\\' height=\\\'400\\\'><rect width=\\\'800\\\' height=\\\'400\\\' fill=\\\'%234a3424\\\'/><text x=\\\'50%\\\' y=\\\'50%\\\' fill=\\\'%23d4af37\\\' font-size=\\\'24\\\' text-anchor=\\\'middle\\\'>[img/party.png Missing]</text></svg>'">
                </div>
                <button class="btn btn-adentrarse" id="btn-enter-landing">ADENTRARSE</button>
            </div>

            <!-- Selection View (Hidden initially via CSS or JS later) -->
            <div id="selection-screen" style="display: none; opacity: 0; width: 100%;">
                <div class="header">
                    <h1>Crónicas de Phandalin</h1>
                    <p>Selecciona tu rol en la campaña...</p>
                </div>
                <div class="grid-3-login">
                    <!-- DM Panel -->
                    <div class="card text-center">
                        <h2>Dungeon Master</h2>
                        <i class="fa-solid fa-dragon fa-3x mb-1" style="color: var(--leather-dark)"></i>
                        <p class="mb-1">Accede al panel de control de la campaña.</p>
                        <input type="password" id="dm-password" placeholder="Contraseña secreta">
                        <button class="btn" id="btn-login-dm"><i class="fa-solid fa-key"></i> Entrar como DM</button>
                        <p id="dm-error"
                            style="color: var(--red-ink); display: none; margin-top: 0.5rem; font-weight: bold;">
                            Contraseña
                            incorrecta</p>
                    </div>
                    <!-- Player Panel -->
                    <div class="card text-center">
                        <h2>Jugador</h2>
                        <i class="fa-solid fa-helmet-battle fa-3x mb-1" style="color: var(--leather-dark)"></i>
                        <p class="mb-1">Selecciona tu personaje o crea uno nuevo.</p>
                        <div id="player-list-container" class="mb-1">
                            <!-- List of existing players injected here -->
                        </div>
                        <button class="btn" id="btn-create-player"><i class="fa-solid fa-plus"></i> Crear
                            Personaje</button>
                    </div>
                    <!-- Public Screen Panel -->
                    <div class="card text-center">
                        <h2>Pantalla del Master</h2>
                        <i class="fa-solid fa-display fa-3x mb-1" style="color: var(--leather-dark)"></i>
                        <p class="mb-1">Proyecta contenido para tus jugadores en una segunda pantalla.</p>
                        <button class="btn" id="btn-login-screen"
                            style="background: var(--leather-dark); color: var(--gold); border-color: var(--leather-dark);"><i
                                class="fa-solid fa-tv"></i> Abrir Pantalla</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main App Screen -->
        <div id="main-screen" class="screen">
            <div class="flex-between mb-1"
                style="border-bottom: 2px solid var(--leather-dark); padding-bottom: 0.5rem;">
                <h2 id="main-header-title">Crónicas de Phandalin</h2>
                <button class="btn btn-danger" id="btn-logout"><i class="fa-solid fa-door-open"></i> Salir</button>
            </div>

            <div class="tabs" id="app-tabs">
                <button class="tab-btn active" data-target="tab-sheet" id="tab-btn-sheet"><i
                        class="fa-solid fa-scroll"></i> Ficha</button>
                <button class="tab-btn" data-target="tab-party" id="tab-btn-party"><i class="fa-solid fa-users"></i>
                    Grupo</button>
                <button class="tab-btn" data-target="tab-npcs" id="tab-btn-npcs"><i class="fa-solid fa-bed"></i>
                    NPCs</button>
                <button class="tab-btn" data-target="tab-maps" id="tab-btn-maps"><i
                        class="fa-solid fa-map-location-dot"></i> Mapas</button>
                <button class="tab-btn" data-target="tab-bestiario" id="tab-btn-bestiario"><i
                        class="fa-solid fa-dragon"></i> Bestiario</button>
                <button class="tab-btn" data-target="tab-encuentros" id="tab-btn-encuentros"><i
                        class="fa-solid fa-swords"></i> Encuentros</button>
                <button class="tab-btn" data-target="tab-notes" id="tab-btn-notes"><i
                        class="fa-solid fa-book-journal-whills"></i> Notas</button>
                <button class="tab-btn" data-target="tab-library" id="tab-btn-library"><i class="fa-solid fa-book"></i>
                    Biblioteca</button>
            </div>

            <!-- Tab Content Containers -->
            <div class="tab-content active" id="tab-sheet"></div>
            <div class="tab-content" id="tab-party"></div>
            <div class="tab-content" id="tab-npcs"></div>
            <div class="tab-content" id="tab-maps"></div>
            <div class="tab-content" id="tab-library"></div>
            <div class="tab-content" id="tab-notes"></div>
            <div class="tab-content" id="tab-bestiario"></div>
            <div class="tab-content" id="tab-encuentros"></div>
        </div>

        <!-- Custom Auth Modal (Magic Lock) -->
        <div id="login-modal-overlay" class="auth-modal-overlay hidden">
            <div id="login-modal" class="auth-modal">
                <h2 id="login-modal-title" style="text-align: center; margin-bottom: 0.5rem;">
                    <i class="fa-solid fa-lock"></i> Sella tu Ficha
                </h2>
                <p id="login-modal-desc" class="text-muted"
                    style="text-align: center; font-size: 0.9em; margin-bottom: 1rem;">
                    Establece una contraseña maestra.
                </p>

                <div style="display: flex; flex-direction: column; gap: 0.8rem;">
                    <input type="password" id="login-modal-pass1" placeholder="Cerrojo Mágico"
                        style="text-align: center; font-size: 1.2rem; letter-spacing: 2px; color: var(--leather-dark); border-radius: 4px; border: 1px solid var(--leather-dark); padding: 5px;">
                    <input type="password" id="login-modal-pass2" placeholder="Repite para confirmar"
                        style="text-align: center; font-size: 1.2rem; letter-spacing: 2px; color: var(--leather-dark); border-radius: 4px; border: 1px solid var(--leather-dark); padding: 5px;">

                    <p id="login-modal-error"
                        style="color: #ff6b6b; font-weight: bold; text-align: center; font-size: 0.85rem; margin: 0; display: none;">
                    </p>

                    <div style="display: flex; gap: 0.5rem; justify-content: center; margin-top: 1rem;">
                        <button class="btn btn-danger" onclick="window.closeLoginModal()">
                            <i class="fa-solid fa-xmark"></i> Atrás
                        </button>
                        <button class="btn" id="login-modal-submit" onclick="window.submitLoginModal()">
                            <i class="fa-solid fa-key"></i> Guardar
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Look Modal Overlay -->
        <div id="quick-look-modal-overlay" class="quick-look-overlay hidden" ondblclick="window.closeQuickLook()">
            <div id="quick-look-container" class="quick-look-container">
                <!-- Dynamic Content Injected Here -->
            </div>
        </div>

        <!-- Lightbox Modal Overlay -->
        <div id="lightbox-modal-overlay" class="lightbox-overlay hidden" onclick="window.closeLightbox()">
            <div class="lightbox-container" onclick="event.stopPropagation()">
                <button class="btn btn-danger lightbox-close" onclick="window.closeLightbox()"><i
                        class="fa-solid fa-xmark"></i></button>
                <img id="lightbox-image" src="" alt="Ampliación">
            </div>
        </div>

        <!-- Entity Form Modal (NPC/Map Editor) -->
        <div id="entity-form-modal" class="auth-modal-overlay hidden" style="z-index: 9000; align-items: center;">
            <div class="auth-modal" style="width: 95%; max-width: 600px; max-height: 90vh; overflow-y: auto;">
                <div class="flex-between mb-1"
                    style="border-bottom: 1px solid var(--parchment-dark); padding-bottom: 0.5rem;">
                    <h2 id="entity-form-title" style="margin-bottom: 0;"><i class="fa-solid fa-pen-to-square"></i>
                        Editor</h2>
                    <button class="btn btn-danger" onclick="window.closeEntityModal()"
                        style="padding: 0.3rem 0.6rem;"><i class="fa-solid fa-xmark"></i></button>
                </div>
                <div id="entity-form-content">
                    <!-- Dynamic form injected by JS -->
                </div>
            </div>
        </div>

    </div>

    <!-- Main Module Script -->
    <script src="./js/tab_notas.js" charset="UTF-8"></script>
    <script src="./js/tab_biblioteca.js" charset="UTF-8"></script>
    <script src="./js/tab_grupo.js" charset="UTF-8"></script>
    <script type="module" src="./js/main.js" charset="UTF-8"></script>
</body>

</html>